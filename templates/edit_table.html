<!DOCTYPE html>
<html>
<head>
    <title>Edit Table: {{ table_name }} - {{ db_file }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { display: inline-block; padding: 8px 16px; margin: 5px; text-decoration: none; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-sm { padding: 6px 12px; font-size: 0.875em; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
        th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; }
        tr:nth-child(even) { background: #f8f9fa; }
        .pagination { text-align: center; margin: 20px 0; }
        .pagination a, .pagination span { display: inline-block; padding: 8px 16px; margin: 0 4px; text-decoration: none; border: 1px solid #ddd; border-radius: 4px; }
        .pagination .current { background: #007bff; color: white; border-color: #007bff; }
        .record-actions { white-space: nowrap; }
        .text-truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; word-wrap: break-word; }
        .flash-messages { margin: 20px 0; }
        .flash-success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb; }
        .flash-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb; }
        .debug-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .null-value { color: #999; font-style: italic; }
        .number-value { color: #0066cc; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Edit Table: {{ table_name }}</h1>
        <p><strong>Database:</strong> {{ db_file }}</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div style="margin: 20px 0;">
            <a href="{{ url_for('manage_specific_database', db_file=db_file) }}" class="btn btn-secondary">‚¨ÖÔ∏è Back to Database</a>
            <a href="{{ url_for('add_database_record', db_file=db_file, table_name=table_name) }}" class="btn btn-success">‚ûï Add New Record</a>
            <a href="{{ url_for('debug_table_access', db_file=db_file, table_name=table_name) }}" class="btn btn-warning">üîç Debug Table</a>
        </div>

        {% if data %}
        <div class="debug-info">
            <strong>Table Info:</strong> {{ data|length }} records shown | {{ total }} total records | {{ schema|length }} columns
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        {% for column in schema %}
                        <th>{{ column.name }} <small>({{ column.type }})</small></th>
                        {% endfor %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in data %}
                    <tr>
                        {% for column in schema %}
                        <td class="text-truncate">
                            {# Safe value handling that works with all data types #}
                            {% set value = record[column.name] %}
                            {% if value is none or value == '' %}
                                <span class="null-value">NULL</span>
                            {% else %}
                                {# Convert everything to string first to avoid type errors #}
                                {% set str_val = value|string %}
                                {% if str_val|length > 100 %}
                                    <span title="{{ str_val }}">{{ str_val[:97] }}...</span>
                                {% else %}
                                    {% if column.type == 'INTEGER' %}
                                        <span class="number-value">{{ value }}</span>
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="record-actions">
                            <a href="{{ url_for('edit_database_record', db_file=db_file, table_name=table_name, record_id=record.id) }}" class="btn btn-primary btn-sm">‚úèÔ∏è Edit</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total > per_page %}
        <div class="pagination">
            {% set total_pages = (total // per_page) + (1 if total % per_page > 0 else 0) %}
            
            {% if page > 1 %}
                <a href="{{ url_for('edit_database_table', db_file=db_file, table_name=table_name, page=page-1) }}">¬´ Previous</a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="current">{{ p }}</span>
                {% else %}
                    <a href="{{ url_for('edit_database_table', db_file=db_file, table_name=table_name, page=p) }}">{{ p }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
                <a href="{{ url_for('edit_database_table', db_file=db_file, table_name=table_name, page=page+1) }}">Next ¬ª</a>
            {% endif %}
        </div>
        {% endif %}

        <div style="margin-top: 20px; color: #666; font-size: 0.9em;">
            <p><strong>Total Records:</strong> {{ total }} | <strong>Page:</strong> {{ page }} | <strong>Records per page:</strong> {{ per_page }}</p>
        </div>
        {% else %}
        <div style="text-align: center; color: #999; padding: 40px;">
            <p>No records found in this table.</p>
            <a href="{{ url_for('add_database_record', db_file=db_file, table_name=table_name) }}" class="btn btn-success">‚ûï Add First Record</a>
        </div>
        {% endif %}
    </div>
</body>
</html>
